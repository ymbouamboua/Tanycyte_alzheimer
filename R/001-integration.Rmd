---
title: "10x Hhuman Median Eminence: Integration"
author: "Mbouamboua Yvon <yvon.mbouamboua@inserm.fr>"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
date: 'Last update: `r format(Sys.time())`'
---

# Goal
Merge datasets from different samples while correcting for batch effects.

# Steps
1. Identify batch effects using exploratory data analysis.
2. Apply batch correction methods (Harmony).
3. Assess integration effectiveness using clustering and visualization.

# Setup

```{r setup, include=TRUE, message=FALSE, warning=FALSE}
invisible(gc())
knitr::opts_chunk$set(warning = FALSE, results = TRUE, message = FALSE, comment = "")
dir.main <- "/Users/yvon.mbouamboua/Documents/projects/singlecell/HME"
dir.results <- file.path(dir.main, "results", "001_integration")
dir.create(dir.results, showWarnings = FALSE, recursive = TRUE)

# Load R packages
packages <- c("Seurat", "ggplot2", "dplyr", "tidyverse", "grid",
              "SingleCellExperiment", "scran", "scater", "pheatmap",
              "ComplexHeatmap", "ComplexUpset", "patchwork",
              "AUCell", "GENIE3", "SCENIC", "dorothea", "WGCNA")
install_and_load <- function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
    BiocManager::install(pkg, ask = FALSE)
  }
  suppressWarnings(suppressMessages(library(pkg, character.only = TRUE)))
}
suppressPackageStartupMessages({
  invisible(lapply(packages, install_and_load))
})

# Load helper functions
utils_dir <- "~/Documents/projects/singlecell/utilities/"
r_files <- list.files(utils_dir, pattern = "\\.R$", full.names = TRUE)
invisible(suppressWarnings(suppressMessages(lapply(r_files, source))))
```

# Analysis

```{r}

obj <- readRDS(file.path(dir.main, "results/000_preprocessing/rdata/merged_2AD_2CTRL.rds"))

```



# Check QC

```{r fig.width=4, fig.height=4}

VlnPlot(obj, group.by="orig.ident", features = c("nFeature_RNA", "nCount_RNA", "percent_mito")) 

```

# Harmony integration

```{r fig.width=8, fig.height=6}

obj <- NormalizeData(obj)
obj <- FindVariableFeatures(obj)
obj <- ScaleData(obj)
obj <- RunPCA(obj, npcs = 50)
obj <- FindNeighbors(obj, dims = 1:50, reduction = "pca")
obj <- FindClusters(obj, resolution = 1, cluster.name = "unintegrated_clusters")
obj <- IntegrateLayers(obj, method = HarmonyIntegration, orig.reduction = "pca", new.reduction = "harmony",verbose = FALSE)
obj <- FindNeighbors(obj, reduction = "harmony", dims = 1:50)
obj <- FindClusters(obj, resolution = 1, cluster.name = "harmony_clusters")
obj <- RunUMAP(obj, reduction = "harmony", dims = 1:50, reduction.name = "umap", min.dist = 0.5)
obj <- JoinLayers(obj)
Dim_Plot(object = obj, group.by = "seurat_clusters", label.show = T, pt.size = 0.5, legend = T, dark.theme = F, figure.plot = T)

saveRDS(obj, file.path(dir.results, "rdata/integrated.rds"))

```

# Check QC post-integration

```{r fig.width=10, fig.height=4}

VlnPlot(obj, group.by="orig.ident", features = c("nFeature_RNA", "nCount_RNA", "percent_mito")) 

```

# Remove low quality clusters (probabily the doublets)

```{r fig.width=8, fig.height=6}

Idents(obj) <- "seurat_clusters"
obj <- subset(obj, idents = c(8,10,23,28,29,33,34), invert = T)
obj <- NormalizeData(obj)
obj <- FindVariableFeatures(obj)
obj <- ScaleData(obj)
obj <- harmony::RunHarmony(obj, group.by.vars = "orig.ident")
obj <- FindNeighbors(obj, dims = 1:50, reduction = "harmony")
obj <- FindClusters(obj, resolution = 1.5, cluster.name = "seurat_clusters")
ndims <- Get_PCs(obj, reduction.name = "harmony")
obj <- RunUMAP(obj, dims = 1:ndims, reduction = "harmony", reduction.name = "umap", min.dist = 1, spread = 2)
DimPlot(obj, group.by = "seurat_clusters")

saveRDS(obj, file.path(dir.results, "rdata/integrated.rds"))

```

# Session Info

```{r session_info}
utils::capture.output(devtools::session_info())
```

